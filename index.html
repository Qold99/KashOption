<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRKASH Store</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and Babel for JSX -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .font-serif { font-family: 'Playfair Display', serif; }
    </style>
</head>
<body class="bg-[#fafafa] text-[#1a1a1a]">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect } = React;
        
        // Firebase Imports via modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Environment Variables
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mrkash-store';

        // Icon Component Helper
        const Icon = ({ name, size = 20, className = "" }) => {
            const [iconHtml, setIconHtml] = useState('');
            useEffect(() => {
                if (window.lucide) {
                    const icon = window.lucide.icons[name];
                    if (icon) setIconHtml(icon.toSvg({ width: size, height: size, class: className }));
                }
            }, [name, size, className]);
            return <span dangerouslySetInnerHTML={{ __html: iconHtml }} />;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('shop');
            const [search, setSearch] = useState('');
            const [products, setProducts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [newProduct, setNewProduct] = useState({ name: '', price: '', link: '', category: '' });

            // Handle Authentication correctly with Rule 3
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Auth failed", e);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) setUser(u);
                });
                return () => unsubscribe();
            }, []);

            // Data Sync with Rule 1 and Rule 3 (Guarding with user)
            useEffect(() => {
                if (!user) return;
                
                // Rule 1: Strict Paths
                const productsRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
                
                const unsubscribe = onSnapshot(productsRef, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Rule 2: Manual sort in memory instead of complex query
                    setProducts(items.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0)));
                    setLoading(false);
                }, (err) => {
                    console.error("Sync error:", err);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user]);

            const handleAdd = async (e) => {
                e.preventDefault();
                if (!user) return;
                try {
                    const productsRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
                    await addDoc(productsRef, { 
                        ...newProduct, 
                        createdAt: new Date().toISOString(),
                        userId: user.uid
                    });
                    setNewProduct({ name: '', price: '', link: '', category: '' });
                } catch (err) {
                    console.error("Add error:", err);
                }
            };

            const handleDelete = async (id) => {
                if (!user) return;
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', id);
                    await deleteDoc(docRef);
                } catch (err) {
                    console.error("Delete error:", err);
                }
            };

            const filtered = products.filter(p => p.name?.toLowerCase().includes(search.toLowerCase()));

            return (
                <div className="min-h-screen">
                    <nav className="fixed w-full z-50 bg-white/70 backdrop-blur-md border-b border-neutral-100 px-8 py-5 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-black rounded-full flex items-center justify-center text-white font-serif text-xs">M</div>
                            <h1 className="text-xl font-serif font-bold tracking-widest">MRKASH</h1>
                        </div>
                        <div className="flex gap-6">
                            <button onClick={() => setView('shop')} className={`text-[10px] tracking-widest uppercase transition-colors ${view === 'shop' ? 'font-black text-black border-b border-black' : 'text-neutral-400 hover:text-black'}`}>Shop</button>
                            <button onClick={() => setView('admin')} className={`text-[10px] tracking-widest uppercase transition-colors ${view === 'admin' ? 'font-black text-black border-b border-black' : 'text-neutral-400 hover:text-black'}`}>Admin</button>
                        </div>
                    </nav>

                    <main className="pt-32 pb-20 px-8">
                        {!user ? (
                            <div className="flex flex-col items-center justify-center py-32 gap-4">
                                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-black"></div>
                                <p className="text-[10px] tracking-widest text-neutral-400 uppercase">Connecting to Services...</p>
                            </div>
                        ) : view === 'shop' ? (
                            <div className="max-w-6xl mx-auto">
                                <header className="text-center mb-16">
                                    <h2 className="text-6xl font-serif mb-8 leading-tight">Curated <span className="italic">Collection.</span></h2>
                                    <div className="relative max-w-md mx-auto">
                                        <input 
                                            type="text" 
                                            placeholder="Search products..." 
                                            className="w-full p-4 pl-5 rounded-xl border border-neutral-100 bg-white shadow-sm outline-none focus:ring-1 focus:ring-black transition-all"
                                            value={search}
                                            onChange={(e) => setSearch(e.target.value)}
                                        />
                                    </div>
                                </header>
                                
                                {loading ? (
                                    <div className="text-center py-20 text-neutral-400 uppercase text-[10px] tracking-widest">Loading Catalog...</div>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-8">
                                        {filtered.map(p => (
                                            <div key={p.id} className="group">
                                                <div className="aspect-[4/5] bg-neutral-100 rounded-2xl mb-4 flex items-center justify-center transition-transform duration-500 group-hover:scale-[1.02]">
                                                    <Icon name="Package" size={40} className="text-neutral-300" />
                                                </div>
                                                <div className="flex justify-between font-bold text-sm mb-1">
                                                    <span>{p.name}</span>
                                                    <span>${p.price}</span>
                                                </div>
                                                <p className="text-[10px] uppercase text-neutral-400 tracking-widest mb-4">{p.category || 'General'}</p>
                                                <a href={p.link} target="_blank" className="block text-center bg-black text-white text-[10px] uppercase py-3 rounded-lg opacity-0 group-hover:opacity-100 transition-all transform translate-y-2 group-hover:translate-y-0">Buy Now</a>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div className="max-w-xl mx-auto">
                                <h2 className="text-3xl font-serif mb-2">Back-office</h2>
                                <p className="text-neutral-400 text-sm mb-8">Management console for your store inventory.</p>
                                
                                <form onSubmit={handleAdd} className="space-y-4 bg-white p-8 rounded-3xl border border-neutral-100 shadow-sm mb-12">
                                    <div className="space-y-1">
                                        <label className="text-[10px] uppercase tracking-widest font-bold text-neutral-400 ml-1">Product Details</label>
                                        <input className="w-full p-4 bg-neutral-50 rounded-xl outline-none focus:ring-1 focus:ring-black transition-all" placeholder="Title" value={newProduct.name} onChange={e => setNewProduct({...newProduct, name: e.target.value})} required />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <input className="p-4 bg-neutral-50 rounded-xl outline-none focus:ring-1 focus:ring-black transition-all" placeholder="Price (e.g. 199)" value={newProduct.price} onChange={e => setNewProduct({...newProduct, price: e.target.value})} required />
                                        <input className="p-4 bg-neutral-50 rounded-xl outline-none focus:ring-1 focus:ring-black transition-all" placeholder="Category" value={newProduct.category} onChange={e => setNewProduct({...newProduct, category: e.target.value})} />
                                    </div>
                                    <input className="w-full p-4 bg-neutral-50 rounded-xl outline-none focus:ring-1 focus:ring-black transition-all" placeholder="Purchase Link (URL)" value={newProduct.link} onChange={e => setNewProduct({...newProduct, link: e.target.value})} required />
                                    <button className="w-full bg-black text-white py-4 rounded-xl uppercase text-xs tracking-widest font-bold hover:opacity-90 transition-opacity">Add to Catalog</button>
                                </form>

                                <div className="space-y-3">
                                    <h3 className="font-bold text-sm uppercase tracking-widest text-neutral-400 mb-4">Live Inventory ({products.length})</h3>
                                    {products.map(p => (
                                        <div key={p.id} className="flex justify-between items-center p-5 bg-white border border-neutral-100 rounded-2xl group hover:border-black transition-colors">
                                            <div className="flex items-center gap-4">
                                                <div className="w-10 h-10 bg-neutral-50 rounded-lg flex items-center justify-center text-neutral-300">
                                                    <Icon name="Package" size={18} />
                                                </div>
                                                <div>
                                                    <span className="text-sm font-bold block">{p.name}</span>
                                                    <span className="text-[10px] text-neutral-400 uppercase tracking-tighter truncate max-w-[150px] block">{p.link}</span>
                                                </div>
                                            </div>
                                            <button onClick={() => handleDelete(p.id)} className="text-neutral-300 hover:text-red-500 transition-colors p-2">
                                                <Icon name="Trash2" size={18} />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>
                    
                    <footer className="py-12 px-8 border-t border-neutral-100 text-center">
                        <p className="text-[10px] tracking-[0.5em] text-neutral-300 uppercase">Â© 2026 MRKASH International</p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

