import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc } from 'firebase/firestore';
import { Search, ShoppingBag, Plus, Trash2, ExternalLink, Package, Loader2 } from 'lucide-react';

// --- CONFIGURATION ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'mrkash-store';

export default function App() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('shop'); // 'shop' or 'admin'
  const [search, setSearch] = useState('');
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isSubmitting, setIsSubmitting] = useState(false);
  
  // Form State for Admin
  const [newProduct, setNewProduct] = useState({ name: '', price: '', link: '', category: '' });

  // 1. Auth Init - Rule 3: Auth Before Queries
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Authentication error:", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
    });
    return () => unsubscribe();
  }, []);

  // 2. Data Sync - Rule 1 & 2: Strict Paths & Simple Queries
  useEffect(() => {
    // Guard: Only query after auth is successful
    if (!user) return;
    
    // Path MUST be /artifacts/{appId}/public/data/{collectionName}
    const productsRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
    
    // Simple query (no orderBy/limit as per Rule 2)
    const unsubscribe = onSnapshot(productsRef, 
      (snapshot) => {
        const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        // Manual sort in JS memory to avoid index requirements
        const sortedItems = items.sort((a, b) => {
          return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
        });
        setProducts(sortedItems);
        setLoading(false);
      }, 
      (error) => {
        console.error("Firestore sync error:", error);
        setLoading(false);
      }
    );
    
    return () => unsubscribe();
  }, [user]);

  // Actions
  const handleAddProduct = async (e) => {
    e.preventDefault();
    if (!newProduct.name || !newProduct.link || !user) return;
    
    setIsSubmitting(true);
    try {
      // Path MUST be /artifacts/{appId}/public/data/{collectionName}
      const productsRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
      await addDoc(productsRef, {
        ...newProduct,
        createdAt: new Date().toISOString()
      });
      setNewProduct({ name: '', price: '', link: '', category: '' });
    } catch (err) {
      console.error("Error adding product:", err);
    } finally {
      setIsSubmitting(false);
    }
  };

  const deleteProduct = async (id) => {
    if (!user) return;
    try {
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', id);
      await deleteDoc(docRef);
    } catch (err) {
      console.error("Error deleting product:", err);
    }
  };

  const filteredProducts = products.filter(p => 
    (p.name?.toLowerCase().includes(search.toLowerCase())) || 
    (p.category?.toLowerCase().includes(search.toLowerCase()))
  );

  return (
    <div className="min-h-screen bg-[#fafafa] text-[#1a1a1a] font-sans selection:bg-black selection:text-white">
      {/* Navigation */}
      <nav className="fixed w-full z-50 bg-white/70 backdrop-blur-xl border-b border-neutral-100 px-8 py-5 flex justify-between items-center">
        <div className="flex items-center gap-2">
          <div className="w-8 h-8 bg-black rounded-full flex items-center justify-center">
            <span className="text-white font-serif text-xs">M</span>
          </div>
          <h1 className="text-xl font-serif tracking-widest font-bold">MRKASH</h1>
        </div>
        <div className="flex gap-8 items-center">
          <button 
            onClick={() => setView('shop')} 
            className={`text-[10px] tracking-[0.2em] uppercase transition-all ${view === 'shop' ? 'font-black border-b-2 border-black' : 'text-neutral-400 hover:text-black'}`}
          >
            Collection
          </button>
          <button 
            onClick={() => setView('admin')} 
            className={`text-[10px] tracking-[0.2em] uppercase transition-all ${view === 'admin' ? 'font-black border-b-2 border-black' : 'text-neutral-400 hover:text-black'}`}
          >
            Inventory
          </button>
          <div className="relative cursor-pointer">
            <ShoppingBag className="w-5 h-5" />
            <span className="absolute -top-1 -right-1 bg-black text-white text-[8px] w-3 h-3 rounded-full flex items-center justify-center">
              {products.length}
            </span>
          </div>
        </div>
      </nav>

      <main className="pt-32 pb-24">
        {!user && (
          <div className="flex flex-col items-center justify-center py-32 gap-4">
            <Loader2 className="animate-spin text-neutral-200" size={40} />
            <p className="text-[10px] tracking-widest text-neutral-400 uppercase">Authenticating Session</p>
          </div>
        )}

        {user && view === 'shop' && (
          <>
            {/* Hero Section */}
            <section className="px-6 py-16 text-center max-w-5xl mx-auto">
              <span className="text-[10px] tracking-[0.4em] uppercase text-neutral-400 mb-4 block">Est. 2024</span>
              <h2 className="text-6xl md:text-8xl font-serif mb-12 leading-[1.1] tracking-tight">
                Curated <span className="italic">Excellence.</span>
              </h2>
              <div className="relative max-w-xl mx-auto group">
                <Search className="absolute left-5 top-1/2 -translate-y-1/2 text-neutral-300 group-focus-within:text-black transition-colors" size={20} />
                <input 
                  type="text" 
                  placeholder="What are you looking for?"
                  className="w-full pl-14 pr-6 py-6 rounded-2xl bg-white border border-neutral-100 shadow-[0_10px_40px_-15px_rgba(0,0,0,0.05)] focus:ring-1 focus:ring-black outline-none transition-all text-base placeholder:text-neutral-300"
                  value={search}
                  onChange={(e) => setSearch(e.target.value)}
                />
              </div>
            </section>

            {/* Catalog */}
            <section className="px-8 max-w-7xl mx-auto">
              {loading ? (
                <div className="flex flex-col items-center justify-center py-32 gap-4">
                  <Loader2 className="animate-spin text-neutral-200" size={40} />
                  <p className="text-[10px] tracking-widest text-neutral-400 uppercase">Synchronizing Catalog</p>
                </div>
              ) : filteredProducts.length > 0 ? (
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-8 gap-y-16">
                  {filteredProducts.map(product => (
                    <div key={product.id} className="group">
                      <div className="aspect-[4/5] bg-[#efefef] rounded-2xl mb-6 overflow-hidden relative flex items-center justify-center transition-transform duration-500 group-hover:scale-[1.02]">
                         <Package className="text-neutral-300" size={60} strokeWidth={1} />
                         <div className="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors duration-500" />
                      </div>
                      <div className="space-y-1">
                        <div className="flex justify-between items-start">
                          <h3 className="text-sm font-medium tracking-tight text-neutral-800">{product.name}</h3>
                          <span className="text-sm font-bold">${product.price}</span>
                        </div>
                        <p className="text-[10px] text-neutral-400 uppercase tracking-widest">{product.category || 'General'}</p>
                      </div>
                      <a 
                        href={product.link} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="mt-6 flex items-center justify-center w-full py-3 bg-black text-white text-[10px] tracking-[0.2em] uppercase rounded-xl opacity-0 group-hover:opacity-100 transition-all duration-300 translate-y-2 group-hover:translate-y-0"
                      >
                        Purchase Now <ExternalLink className="ml-2" size={12} />
                      </a>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-32">
                  <p className="text-neutral-400 font-serif italic text-lg">Our archives do not contain your request.</p>
                  <button onClick={() => setSearch('')} className="mt-4 text-[10px] tracking-widest uppercase border-b border-black">View All</button>
                </div>
              )}
            </section>
          </>
        )}

        {user && view === 'admin' && (
          /* Admin Dashboard */
          <section className="px-6 max-w-2xl mx-auto animate-in fade-in slide-in-from-bottom-4">
            <div className="mb-12">
              <h2 className="text-4xl font-serif mb-2">Back-office</h2>
              <p className="text-neutral-400 text-sm">Update your world-class catalog and links.</p>
            </div>
            
            <form onSubmit={handleAddProduct} className="bg-white p-10 rounded-3xl border border-neutral-100 mb-16 shadow-xl shadow-black/[0.02]">
              <div className="flex items-center gap-3 mb-8 border-b border-neutral-50 pb-6">
                <div className="w-10 h-10 rounded-full bg-neutral-50 flex items-center justify-center">
                  <Plus size={20} className="text-black" />
                </div>
                <h3 className="text-lg font-bold">New Listing</h3>
              </div>

              <div className="space-y-5">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                  <div className="space-y-1.5">
                    <label className="text-[10px] uppercase tracking-widest font-bold text-neutral-400 ml-1">Title</label>
                    <input 
                      className="w-full p-4 bg-neutral-50 border-none rounded-2xl focus:ring-2 focus:ring-black outline-none transition-all" 
                      placeholder="e.g. Silk Essential Shirt" 
                      value={newProduct.name}
                      onChange={e => setNewProduct({...newProduct, name: e.target.value})}
                      required
                    />
                  </div>
                  <div className="space-y-1.5">
                    <label className="text-[10px] uppercase tracking-widest font-bold text-neutral-400 ml-1">Price ($)</label>
                    <input 
                      className="w-full p-4 bg-neutral-50 border-none rounded-2xl focus:ring-2 focus:ring-black outline-none transition-all" 
                      placeholder="0.00" 
                      value={newProduct.price}
                      onChange={e => setNewProduct({...newProduct, price: e.target.value})}
                      required
                    />
                  </div>
                </div>
                
                <div className="space-y-1.5">
                  <label className="text-[10px] uppercase tracking-widest font-bold text-neutral-400 ml-1">Direct Purchase Link</label>
                  <input 
                    className="w-full p-4 bg-neutral-50 border-none rounded-2xl focus:ring-2 focus:ring-black outline-none transition-all" 
                    placeholder="https://..." 
                    value={newProduct.link}
                    onChange={e => setNewProduct({...newProduct, link: e.target.value})}
                    required
                  />
                </div>

                <div className="space-y-1.5">
                  <label className="text-[10px] uppercase tracking-widest font-bold text-neutral-400 ml-1">Category</label>
                  <input 
                    className="w-full p-4 bg-neutral-50 border-none rounded-2xl focus:ring-2 focus:ring-black outline-none transition-all" 
                    placeholder="Apparel, Lifestyle, etc." 
                    value={newProduct.category}
                    onChange={e => setNewProduct({...newProduct, category: e.target.value})}
                  />
                </div>

                <button 
                  disabled={isSubmitting}
                  className="mt-4 w-full bg-black text-white py-5 rounded-2xl font-bold hover:scale-[0.99] active:scale-95 transition-all flex items-center justify-center gap-2 disabled:opacity-50"
                >
                  {isSubmitting ? <Loader2 className="animate-spin" size={20} /> : 'Synchronize Product'}
                </button>
              </div>
            </form>

            <div className="space-y-6">
              <div className="flex justify-between items-end">
                <h3 className="font-bold text-xl">Active Catalog</h3>
                <span className="text-[10px] tracking-widest text-neutral-400 uppercase">{products.length} Entries</span>
              </div>
              
              <div className="space-y-3">
                {products.length === 0 && !loading && (
                  <div className="p-8 text-center border-2 border-dashed border-neutral-100 rounded-3xl text-neutral-400 italic">
                    Catalog is currently empty.
                  </div>
                )}
                {products.map(p => (
                  <div key={p.id} className="group flex items-center justify-between bg-white p-5 rounded-2xl border border-neutral-100 hover:border-black transition-colors">
                    <div className="flex items-center gap-4">
                      <div className="w-12 h-12 bg-neutral-50 rounded-xl flex items-center justify-center text-neutral-300">
                        <Package size={20} />
                      </div>
                      <div>
                        <p className="font-bold text-sm">{p.name}</p>
                        <p className="text-[10px] text-neutral-400 uppercase tracking-tighter max-w-[200px] truncate">{p.link}</p>
                      </div>
                    </div>
                    <button 
                      onClick={() => deleteProduct(p.id)} 
                      className="text-neutral-300 hover:text-red-500 p-2 transition-colors"
                      title="Remove from catalog"
                    >
                      <Trash2 size={18} />
                    </button>
                  </div>
                ))}
              </div>
            </div>
          </section>
        )}
      </main>
      
      {/* Footer */}
      <footer className="border-t border-neutral-100 py-12 px-8 text-center">
        <p className="text-[10px] tracking-[0.5em] text-neutral-300 uppercase">Â© 2024 MRKASH International</p>
      </footer>
    </div>
  );
}

